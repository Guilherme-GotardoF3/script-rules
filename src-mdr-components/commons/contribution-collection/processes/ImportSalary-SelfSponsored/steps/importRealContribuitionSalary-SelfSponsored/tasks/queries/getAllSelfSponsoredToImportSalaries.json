{
  "_id": "6695446c639a160ead88a544",
  "type": {
    "_id": "6695446c22dedb054b57d880",
    "name": "queries"
  },
  "name": "getAllSelfSponsoredToImportSalaries",
  "description": "Busca os autopatrocinados para processamento do salario",
  "main_collection": "people",
  "output_name": "otp_getAllSelfSponsoredToImportSalaries",
  "fixed_value": true,
  "input_parameters": [
    {
      "name": "plan",
      "type": "Action System",
      "description": "Variável do sistema usada na agregação"
    },
    {
      "name": "competenceDate",
      "type": "Action System",
      "description": "Variável do sistema usada na agregação"
    },
    {
      "name": "salaryImportGenerationId",
      "type": "Action System",
      "description": "Variável do sistema usada na agregação"
    }
  ],
  "collections": [
    "salary_imports"
  ],
  "output": {},
  "Aggregation": [
    {
      "$match": {
        "participations.participationClass.plan._id": "$.plan"
      }
    },
    {
      "$unwind": {
        "path": "$participations"
      }
    },
    {
      "$addFields": {
        "bundle": {
          "competenceDate": {
            "$toDate": "$.competenceDate"
          },
          "plan": "$.plan",
          "salaryImportGeneration": "$.salaryImportGenerationId"
        }
      }
    },
    {
      "$match": {
        "$expr": {
          "$and": [
            {
              "$eq": [
                "$participations.participationClass.plan._id",
                "$bundle.plan"
              ]
            },
            {
              "$eq": [
                "$participations.participationClass.type.name",
                "Contribuinte"
              ]
            },
            {
              "$eq": [
                "$participations.participationClass.status.name",
                "Autopatrocinado"
              ]
            },
            {
              "$or": [
                {
                  "$eq": [
                    "$participations.participationClass.plan._id",
                    "$bundle.plan"
                  ]
                },
                {
                  "$eq": [
                    "$participations.participationClass.type.name",
                    "Autopatrocinado"
                  ]
                },
                {
                  "$eq": [
                    "$participations.participationClass.status.name",
                    "Contribuinte"
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    {
      "$project": {
        "_id": 1,
        "name": 1,
        "documents": 1,
        "participations": 1,
        "competenceDate": {
          "$toDate": "$bundle.competenceDate"
        },
        "referenceDate": {
          "$toDate": "$bundle.competenceDate"
        },
        "salaryImportGeneration": "$bundle.salaryImportGeneration"
      }
    },
    {
      "$lookup": {
        "from": "salary_imports",
        "localField": "participations._id",
        "foreignField": "person.participation._id",
        "as": "lastSalaryImports",
        "let": {
          "competenceDate": "$competenceDate"
        },
        "pipeline": [
          {
            "$match": {
              "$expr": {
                "$lte": [
                  "$competenceDate",
                  "$$competenceDate"
                ]
              }
            }
          },
          {
            "$unwind": {
              "path": "$salaries"
            }
          },
          {
            "$match": {
              "$expr": [
                {
                  "$eq": [
                    "$type",
                    "base"
                  ]
                }
              ]
            }
          },
          {
            "$project": {
              "_id": 1,
              "competenceDate": 1,
              "salaries": 1
            }
          },
          {
            "$sort": {
              "competenceDate": -1
            }
          },
          {
            "$limit": 1
          }
        ]
      }
    },
    {
      "$unwind": {
        "path": "$lastSalaryImports",
        "preserveNullAndEmptyArrays": true
      }
    },
    {
      "$project": {
        "salaryImportGeneration": 1,
        "person": {
          "_id": "$_id",
          "name": "$name",
          "documents": "$documents",
          "participation": "$participations"
        },
        "competenceDate": 1,
        "referenceDate": 1,
        "salaries": {
          "source": "company",
          "amount": {
            "$toDouble": "$lastSalaryImports.salaries.amount"
          },
          "type": "base",
          "variation": {
            "$toInt": 1
          }
        }
      }
    }
  ]
}
